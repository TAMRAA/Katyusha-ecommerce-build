{"version":3,"sources":["turbopack:///[project]/node_modules/@sanity/presentation-comlink/src/comlinkCompatibility.ts","turbopack:///[project]/node_modules/@sanity/presentation-comlink/src/isMaybePresentation.ts","turbopack:///[project]/node_modules/fast-deep-equal/index.js","turbopack:///[project]/node_modules/sanity/src/presentation/loader/DisplayedDocumentBroadcaster.tsx"],"sourcesContent":["import {\n  createListenLogic,\n  createRequestMachine,\n  DOMAIN,\n  MSG_DISCONNECT,\n  MSG_HANDSHAKE_ACK,\n  MSG_HANDSHAKE_SYN,\n  MSG_HANDSHAKE_SYN_ACK,\n  MSG_HEARTBEAT,\n  MSG_RESPONSE,\n  type InternalMessageType,\n  type Message,\n  type ProtocolMessage,\n  type RequestMachineContext,\n} from '@sanity/comlink'\nimport type {\n  LoaderControllerMsg,\n  LoaderNodeMsg,\n  PreviewKitNodeMsg,\n  VisualEditingControllerMsg,\n  VisualEditingNodeMsg,\n} from './types'\n\ntype ComlinkMessageType =\n  | InternalMessageType\n  | (\n      | LoaderControllerMsg\n      | LoaderNodeMsg\n      | PreviewKitNodeMsg\n      | VisualEditingControllerMsg\n      | VisualEditingNodeMsg\n    )['type']\n\ntype ChannelsMessageType =\n  | 'handshake/syn'\n  | 'handshake/syn-ack'\n  | 'handshake/ack'\n  | 'channel/response'\n  | 'channel/heartbeat'\n  | 'channel/disconnect'\n  | 'overlay/focus'\n  | 'overlay/navigate'\n  | 'overlay/toggle'\n  | 'presentation/toggleOverlay'\n\nconst channelsToComlinkMap: {[key in ChannelsMessageType]: ComlinkMessageType} = {\n  'handshake/syn': MSG_HANDSHAKE_SYN,\n  'handshake/syn-ack': MSG_HANDSHAKE_SYN_ACK,\n  'handshake/ack': MSG_HANDSHAKE_ACK,\n  'channel/response': MSG_RESPONSE,\n  'channel/heartbeat': MSG_HEARTBEAT,\n  'channel/disconnect': MSG_DISCONNECT,\n  'overlay/focus': 'visual-editing/focus',\n  'overlay/navigate': 'visual-editing/navigate',\n  'overlay/toggle': 'visual-editing/toggle',\n  'presentation/toggleOverlay': 'presentation/toggle-overlay',\n}\n\nconst comlinkToChannelsMap: {[key in ComlinkMessageType]?: ChannelsMessageType} = {\n  [MSG_HANDSHAKE_SYN]: 'handshake/syn',\n  [MSG_HANDSHAKE_SYN_ACK]: 'handshake/syn-ack',\n  [MSG_HANDSHAKE_ACK]: 'handshake/ack',\n  [MSG_RESPONSE]: 'channel/response',\n  [MSG_HEARTBEAT]: 'channel/heartbeat',\n  [MSG_DISCONNECT]: 'channel/disconnect',\n  'visual-editing/focus': 'overlay/focus',\n  'visual-editing/navigate': 'overlay/navigate',\n  'visual-editing/toggle': 'overlay/toggle',\n  'presentation/toggle-overlay': 'presentation/toggleOverlay',\n}\n\ntype ChannelMsg = Omit<ProtocolMessage, 'channelId'> & {connectionId: string}\n\nconst convertToComlinkEvent = (event: MessageEvent): MessageEvent<ProtocolMessage> => {\n  const {data} = event\n\n  if (\n    data &&\n    typeof data === 'object' &&\n    'domain' in data &&\n    'type' in data &&\n    'from' in data &&\n    'to' in data\n  ) {\n    if (data.domain === 'sanity/channels') {\n      data.domain = DOMAIN\n    }\n\n    if (data.to === 'overlays') {\n      data.to = 'visual-editing'\n    }\n\n    if (data.from === 'overlays') {\n      data.from = 'visual-editing'\n    }\n\n    data.channelId = data.connectionId\n    delete data.connectionId\n\n    data.type = channelsToComlinkMap[data.type as ChannelsMessageType] ?? data.type\n  }\n\n  return event\n}\n\nconst convertToChannelsMessage = (comlinkMessage: ProtocolMessage): ChannelMsg => {\n  const {channelId, ...rest} = comlinkMessage\n  const message = {...rest, connectionId: channelId} as ChannelMsg\n\n  if (message.domain === DOMAIN) {\n    message.domain = 'sanity/channels'\n  }\n\n  if (message.to === 'visual-editing') {\n    message.to = 'overlays'\n  }\n\n  if (message.from === 'visual-editing') {\n    message.from = 'overlays'\n  }\n\n  message.type = comlinkToChannelsMap[message.type as ComlinkMessageType] ?? message.type\n\n  if (message.type === 'channel/response' && message.responseTo && !message.data) {\n    message.data = {responseTo: message.responseTo}\n  }\n\n  if (\n    message.type === 'handshake/syn' ||\n    message.type === 'handshake/syn-ack' ||\n    message.type === 'handshake/ack'\n  ) {\n    message.data = {id: message.connectionId}\n  }\n\n  return message\n}\n\nconst sendAsChannelsMessage = <S extends Message>(\n  {context}: {context: RequestMachineContext<S>},\n  params: {message: ProtocolMessage},\n): void => {\n  const {sources, targetOrigin} = context\n\n  const message = convertToChannelsMessage(params.message)\n\n  sources.forEach((source) => {\n    source.postMessage(message, {targetOrigin})\n  })\n}\n\nexport {\n  type ListenInput,\n  type Message,\n  type MessageData,\n  type MessageType,\n  MSG_RESPONSE,\n  type ProtocolMessage,\n  type RequestMachineContext,\n  type ResponseMessage,\n} from '@sanity/comlink'\n\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\nexport const createCompatibilityActors = <T extends Message>() => ({\n  listen: createListenLogic(convertToComlinkEvent),\n  requestMachine: createRequestMachine<T>().provide({\n    actions: {\n      'send message': sendAsChannelsMessage,\n    },\n  }),\n})\n","export function isMaybePreviewIframe(): boolean {\n  return window.self !== window.top\n}\nexport function isMaybePreviewWindow(): boolean {\n  return Boolean(window.opener)\n}\nexport function isMaybePresentation(): boolean {\n  return isMaybePreviewIframe() || isMaybePreviewWindow()\n}\n","'use strict';\n\n// do not edit .js files directly - edit src/index.jst\n\n\n\nmodule.exports = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == 'object' && typeof b == 'object') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n","/**\n * Report back up the document state being displayed in the document pane,\n * allowing Presentation Tool to patch the live queries with the same state.\n * This makes the Perspective switcher less confusing, as it applies to everything else on the page.\n * It's also why it's possible to select an older revision and see it in the preview,\n * effectively letting you preview a revert action you might be considering to perform.\n */\n\nimport isEqual from 'fast-deep-equal'\nimport {type PropsWithChildren, useCallback, useContext, useEffect} from 'react'\nimport {type SanityDocument} from 'sanity'\nimport {PresentationDisplayedDocumentContext} from 'sanity/_singletons'\n\nimport {type PresentationDisplayedDocumentContextValue} from './types'\n\nexport interface DisplayedDocumentBroadcasterProps extends PropsWithChildren {\n  setDisplayedDocument: React.Dispatch<\n    React.SetStateAction<Partial<SanityDocument> | null | undefined>\n  >\n  documentId: string | null | undefined\n}\n\nexport function DisplayedDocumentBroadcasterProvider(\n  props: DisplayedDocumentBroadcasterProps,\n): React.JSX.Element {\n  const {children, setDisplayedDocument, documentId} = props\n\n  const context = useCallback<PresentationDisplayedDocumentContextValue>(\n    (next) => setDisplayedDocument((prev) => (isEqual(prev, next) ? prev : next)),\n    [setDisplayedDocument],\n  )\n\n  useEffect(() => {\n    // If no document is currently being displayed then reset the state\n    if (documentId) {\n      return undefined\n    }\n    const timeout = setTimeout(() => setDisplayedDocument(null))\n    return () => clearTimeout(timeout)\n  }, [documentId, setDisplayedDocument])\n\n  return (\n    <PresentationDisplayedDocumentContext.Provider value={context}>\n      {children}\n    </PresentationDisplayedDocumentContext.Provider>\n  )\n}\n\nexport function useDisplayedDocumentBroadcaster(): PresentationDisplayedDocumentContextValue | null {\n  return useContext(PresentationDisplayedDocumentContext)\n}\n"],"names":["DisplayedDocumentBroadcasterProvider","props","$","_c","children","setDisplayedDocument","documentId","t0","next","prev","isEqual","context","t1","t2","timeout","setTimeout","clearTimeout","useEffect","t3","useDisplayedDocumentBroadcaster","useContext","PresentationDisplayedDocumentContext"],"mappings":"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","ignoreList":[2]}